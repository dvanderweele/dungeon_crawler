(()=>{"use strict";var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,o=(t,r,n)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n,a=(e,t)=>{for(var r in t||(t={}))i.call(t,r)&&o(e,r,t[r]);if(n)for(var r of n(t))s.call(t,r)&&o(e,r,t[r]);return e},l=(e,n)=>t(e,r(n)),u=(t,r)=>e(t,"name",{value:r,configurable:!0}),h=(e,t)=>()=>(e&&(t=e(e=0)),t);function c(e){return e*Math.PI/180}function d(e){return 180*e/Math.PI}function f(e,t,r){return t>r?f(e,r,t):Math.min(Math.max(e,t),r)}function m(e,t,r){return e+(t-e)*r}function p(e,t,r,n,i){return n+(e-t)/(r-t)*(i-n)}function g(e,t,r,n,i){return f(p(e,t,r,n,i),n,i)}function y(...e){if(0===e.length)return y(0,0);if(1===e.length){if("number"==typeof e[0])return y(e[0],e[0]);if(x(e[0]))return y(e[0].x,e[0].y);if(Array.isArray(e[0])&&2===e[0].length)return y.apply(null,e[0])}return{x:e[0],y:e[1],clone(){return y(this.x,this.y)},add(...e){let t=y(...e);return y(this.x+t.x,this.y+t.y)},sub(...e){let t=y(...e);return y(this.x-t.x,this.y-t.y)},scale(e){return y(this.x*e,this.y*e)},dist(...e){let t=y(...e);return Math.sqrt((this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y))},len(){return this.dist(y(0,0))},unit(){return this.scale(1/this.len())},normal(){return y(this.y,-this.x)},dot(...e){let t=y(...e);return y(this.x*t.x,this.y*t.y)},angle(...e){let t=y(...e);return Math.atan2(this.y-t.y,this.x-t.x)},lerp(e,t){return y(m(this.x,e.x,t),m(this.y,e.y,t))},eq(e){return this.x===e.x&&this.y===e.y},str(){return`(${this.x}, ${this.y})`}}}function w(e){return y(Math.cos(e),Math.sin(e))}function v(e,t,r){return{x:e,y:t,z:r,xy(){return y(this.x,this.y)}}}function x(e){return void 0!==e&&void 0!==e.x&&void 0!==e.y}function b(e){return void 0!==e&&void 0!==e.x&&void 0!==e.y&&void 0!==e.z}function k(e){return void 0!==e&&void 0!==e.r&&void 0!==e.g&&void 0!==e.b&&void 0!==e.a}function R(e){if(void 0!==e&&Array.isArray(e.m)&&16===e.m.length)return e}function A(...e){if(0===e.length)return P();if(1===e.length){if(k(e[0]))return P(e[0]);if(Array.isArray(e[0])&&3===e[0].length)return A.apply(null,e[0])}return P(e[0],e[1],e[2],1)}function P(...e){var t;if(0===e.length)return P(1,1,1,1);if(1===e.length){if(k(e[0]))return P(e[0].r,e[0].g,e[0].b,e[0].a);if(Array.isArray(e[0])&&4===e[0].length)return P.apply(null,e[0])}return{r:e[0],g:e[1],b:e[2],a:null!=(t=e[3])?t:1,clone(){return P(this.r,this.g,this.b,this.a)},lighten(e){return P(this.r+e,this.g+e,this.b+e,this.a)},darken(e){return this.lighten(-e)},invert(){return P(1-this.r,1-this.g,1-this.b,this.a)},isDark(e=.5){return this.r+this.g+this.b<3*e},isLight(e=.5){return this.r+this.g+this.b>3*e},eq(e){return this.r===e.r&&this.g===e.g&&this.b===e.g&&this.a===e.a}}}function E(e,t,r,n){return{x:e,y:t,w:r,h:n,clone(){return E(this.x,this.y,this.w,this.h)},eq(e){return this.x===e.x&&this.y===e.y&&this.w===e.w&&this.h===e.h}}}function S(e){return{m:e?[...e]:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],clone(){return S(this.m)},mult(e){let t=[];for(let r=0;r<4;r++)for(let n=0;n<4;n++)t[4*r+n]=this.m[0+n]*e.m[4*r+0]+this.m[4+n]*e.m[4*r+1]+this.m[8+n]*e.m[4*r+2]+this.m[12+n]*e.m[4*r+3];return S(t)},multVec4(e){return{x:e.x*this.m[0]+e.y*this.m[4]+e.z*this.m[8]+e.w*this.m[12],y:e.x*this.m[1]+e.y*this.m[5]+e.z*this.m[9]+e.w*this.m[13],z:e.x*this.m[2]+e.y*this.m[6]+e.z*this.m[10]+e.w*this.m[14],w:e.x*this.m[3]+e.y*this.m[7]+e.z*this.m[11]+e.w*this.m[15]}},multVec3(e){let t=this.multVec4({x:e.x,y:e.y,z:e.z,w:1});return v(t.x,t.y,t.z)},multVec2(e){return y(e.x*this.m[0]+e.y*this.m[4]+0*this.m[8]+1*this.m[12],e.x*this.m[1]+e.y*this.m[5]+0*this.m[9]+1*this.m[13])},translate(e){return this.mult(S([1,0,0,0,0,1,0,0,0,0,1,0,e.x,e.y,0,1]))},scale(e){return this.mult(S([e.x,0,0,0,0,e.y,0,0,0,0,1,0,0,0,0,1]))},rotateX(e){return this.mult(S([1,0,0,0,0,Math.cos(e),-Math.sin(e),0,0,Math.sin(e),Math.cos(e),0,0,0,0,1]))},rotateY(e){return this.mult(S([Math.cos(e),0,-Math.sin(e),0,0,1,0,0,Math.sin(e),0,Math.cos(e),0,0,0,0,1]))},rotateZ(e){return this.mult(S([Math.cos(e),-Math.sin(e),0,0,Math.sin(e),Math.cos(e),0,0,0,0,1,0,0,0,0,1]))},invert(){let e=[],t=this.m[10]*this.m[15]-this.m[14]*this.m[11],r=this.m[9]*this.m[15]-this.m[13]*this.m[11],n=this.m[9]*this.m[14]-this.m[13]*this.m[10],i=this.m[8]*this.m[15]-this.m[12]*this.m[11],s=this.m[8]*this.m[14]-this.m[12]*this.m[10],o=this.m[8]*this.m[13]-this.m[12]*this.m[9],a=this.m[6]*this.m[15]-this.m[14]*this.m[7],l=this.m[5]*this.m[15]-this.m[13]*this.m[7],u=this.m[5]*this.m[14]-this.m[13]*this.m[6],h=this.m[4]*this.m[15]-this.m[12]*this.m[7],c=this.m[4]*this.m[14]-this.m[12]*this.m[6],d=this.m[5]*this.m[15]-this.m[13]*this.m[7],f=this.m[4]*this.m[13]-this.m[12]*this.m[5],m=this.m[6]*this.m[11]-this.m[10]*this.m[7],p=this.m[5]*this.m[11]-this.m[9]*this.m[7],g=this.m[5]*this.m[10]-this.m[9]*this.m[6],y=this.m[4]*this.m[11]-this.m[8]*this.m[7],w=this.m[4]*this.m[10]-this.m[8]*this.m[6],v=this.m[4]*this.m[9]-this.m[8]*this.m[5];e[0]=this.m[5]*t-this.m[6]*r+this.m[7]*n,e[4]=-(this.m[4]*t-this.m[6]*i+this.m[7]*s),e[8]=this.m[4]*r-this.m[5]*i+this.m[7]*o,e[12]=-(this.m[4]*n-this.m[5]*s+this.m[6]*o),e[1]=-(this.m[1]*t-this.m[2]*r+this.m[3]*n),e[5]=this.m[0]*t-this.m[2]*i+this.m[3]*s,e[9]=-(this.m[0]*r-this.m[1]*i+this.m[3]*o),e[13]=this.m[0]*n-this.m[1]*s+this.m[2]*o,e[2]=this.m[1]*a-this.m[2]*l+this.m[3]*u,e[6]=-(this.m[0]*a-this.m[2]*h+this.m[3]*c),e[10]=this.m[0]*d-this.m[1]*h+this.m[3]*f,e[14]=-(this.m[0]*u-this.m[1]*c+this.m[2]*f),e[3]=-(this.m[1]*m-this.m[2]*p+this.m[3]*g),e[7]=this.m[0]*m-this.m[2]*y+this.m[3]*w,e[11]=-(this.m[0]*p-this.m[1]*y+this.m[3]*v),e[15]=this.m[0]*g-this.m[1]*w+this.m[2]*v;let x=this.m[0]*e[0]+this.m[1]*e[4]+this.m[2]*e[8]+this.m[3]*e[12];for(let t=0;t<4;t++)for(let r=0;r<4;r++)e[4*t+r]*=1/x;return S(e)}}}function T(e,t,r){return e+(Math.sin(r)+1)/2*(t-e)}function _(e){return{seed:e,gen(...e){if(0===e.length)return this.seed=(B*this.seed+O)%j,this.seed/j;if(1===e.length){if("number"==typeof e[0])return this.gen(0,e[0]);if(x(e[0]))return this.gen(y(0,0),e[0]);if(k(e[0]))return this.gen(P(0,0,0,0),e[0])}else if(2===e.length){if("number"==typeof e[0]&&"number"==typeof e[1])return this.gen()*(e[1]-e[0])+e[0];if(x(e[0])&&x(e[1]))return y(this.gen(e[0].x,e[1].x),this.gen(e[0].y,e[1].y));if(k(e[0])&&k(e[1]))return P(this.gen(e[0].r,e[1].r),this.gen(e[0].g,e[1].g),this.gen(e[0].b,e[1].b),this.gen(e[0].a,e[1].a))}}}}function D(e){Y.seed=e}function F(...e){return Y.gen(...e)}function M(e){return F()<=e}function I(e){return e[Math.floor(F(e.length))]}function L(e,t){return e.p2.x>=t.p1.x&&e.p1.x<=t.p2.x&&e.p2.y>=t.p1.y&&e.p1.y<=t.p2.y}function C(e,t){return e.p2.x>t.p1.x&&e.p1.x<t.p2.x&&e.p2.y>t.p1.y&&e.p1.y<t.p2.y}function q(e,t){return t.x>=e.p1.x&&t.x<=e.p2.x&&t.y>=e.p1.y&&t.y<e.p2.y}var B,O,j,Y,N=h((()=>{u(c,"deg2rad"),u(d,"rad2deg"),u(f,"clamp"),u(m,"lerp"),u(p,"map"),u(g,"mapc"),u(y,"vec2"),u(w,"vec2FromAngle"),u(v,"vec3"),u(x,"isVec2"),u(b,"isVec3"),u(k,"isColor"),u(R,"isMat4"),u(A,"rgb"),u(P,"rgba"),u(E,"quad"),u(S,"mat4"),u(T,"wave"),B=1103515245,O=12345,j=2147483648,Y=_(Date.now()),u(_,"makeRng"),u(D,"randSeed"),u(F,"rand"),u(M,"chance"),u(I,"choose"),u(L,"colRectRect"),u(C,"overlapRectRect"),u(q,"colRectPt")}));function U(e,t){let r=typeof e,n=typeof t;if(r!==n)return!1;if("object"===r&&"object"===n){let r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(let n of r){let r=e[n],i=t[n];if(("function"!=typeof r||"function"!=typeof i)&&!U(r,i))return!1}return!0}return e===t}var z=h((()=>{u(U,"deepEq")}));function H(e){switch(e){case"topleft":return y(-1,-1);case"top":return y(0,-1);case"topright":return y(1,-1);case"left":return y(-1,0);case"center":return y(0,0);case"right":return y(1,0);case"botleft":return y(-1,1);case"bot":return y(0,1);case"botright":return y(1,1);default:return e}}function X(e,t){let r=(()=>{switch(t.texFilter){case"linear":return e.LINEAR;case"nearest":default:return e.NEAREST}})(),n=(()=>{var r;let n=o(Z,$),i=s(new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),a=null!=(r=t.clearColor)?r:P(0,0,0,1);e.clearColor(a.r,a.g,a.b,a.a),e.enable(e.BLEND),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);let l=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,4*V,e.DYNAMIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null);let u=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,u),e.bufferData(e.ELEMENT_ARRAY_BUFFER,2*V,e.DYNAMIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);let h=s(new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2));return{drawCalls:0,lastDrawCalls:0,defProg:n,curProg:n,defTex:i,curTex:i,curUniform:{},vbuf:l,ibuf:u,vqueue:[],iqueue:[],transform:S(),transformStack:[],clearColor:a,bgTex:h}})();function i(e){return Math.log(e)/Math.log(2)%1==0}function s(t){let n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r);let s=i(t.width)&&i(t.height)?e.REPEAT:e.CLAMP_TO_EDGE;return e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,s),e.bindTexture(e.TEXTURE_2D,null),{width:t.width,height:t.height,bind(){e.bindTexture(e.TEXTURE_2D,n)},unbind(){e.bindTexture(e.TEXTURE_2D,null)}}}function o(t=Z,r=$){let n,i=W.replace("{{user}}",null!=t?t:Z),s=Q.replace("{{user}}",null!=r?r:$),o=e.createShader(e.VERTEX_SHADER),a=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(o,i),e.shaderSource(a,s),e.compileShader(o),e.compileShader(a),n=e.getShaderInfoLog(o))throw new Error(n);if(n=e.getShaderInfoLog(a))throw new Error(n);let l=e.createProgram();if(e.attachShader(l,o),e.attachShader(l,a),e.bindAttribLocation(l,0,"a_pos"),e.bindAttribLocation(l,1,"a_uv"),e.bindAttribLocation(l,2,"a_color"),e.linkProgram(l),(n=e.getProgramInfoLog(l))&&"\n"!==n)throw new Error(n);return{bind(){e.useProgram(l)},unbind(){e.useProgram(null)},bindAttribs(){e.vertexAttribPointer(0,3,e.FLOAT,!1,4*G,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,4*G,12),e.enableVertexAttribArray(1),e.vertexAttribPointer(2,4,e.FLOAT,!1,4*G,20),e.enableVertexAttribArray(2)},send(t){this.bind();for(let r in t){let n=t[r],i=e.getUniformLocation(l,r);"number"==typeof n?e.uniform1f(i,n):R(n)?e.uniformMatrix4fv(i,!1,new Float32Array(n.m)):k(n)?e.uniform4f(i,n.r,n.g,n.b,n.a):b(n)?e.uniform3f(i,n.x,n.y,n.z):x(n)&&e.uniform2f(i,n.x,n.y)}this.unbind()}}}function h(e,t,r,n){let i=e.width/t,s=1/i,o=1/(e.height/r),a={},l=n.split("").entries();for(let[e,t]of l)a[t]=y(e%i*s,Math.floor(e/i)*o);return{tex:e,map:a,qw:s,qh:o}}function c(e,t,r=n.defTex,i=n.defProg,s={}){r=null!=r?r:n.defTex,i=null!=i?i:n.defProg,(r!==n.curTex||i!==n.curProg||!U(n.curUniform,s)||n.vqueue.length+e.length*G>V||n.iqueue.length+t.length>V)&&d(),n.curTex=r,n.curProg=i,n.curUniform=s;let o=t.map((e=>e+n.vqueue.length/G)),a=e.map((e=>{let t=g(n.transform.multVec2(e.pos.xy()));return[t.x,t.y,e.pos.z,e.uv.x,e.uv.y,e.color.r,e.color.g,e.color.b,e.color.a]})).flat();o.forEach((e=>n.iqueue.push(e))),a.forEach((e=>n.vqueue.push(e)))}function d(){!n.curTex||!n.curProg||0===n.vqueue.length||0===n.iqueue.length||(n.curProg.send(n.curUniform),e.bindBuffer(e.ARRAY_BUFFER,n.vbuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(n.vqueue)),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.ibuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(n.iqueue)),n.curProg.bind(),n.curProg.bindAttribs(),n.curTex.bind(),e.drawElements(e.TRIANGLES,n.iqueue.length,e.UNSIGNED_SHORT,0),n.curTex.unbind(),n.curProg.unbind(),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),n.iqueue=[],n.vqueue=[],n.drawCalls++)}function f(){e.clear(e.COLOR_BUFFER_BIT),t.clearColor||M({width:Y(),height:N(),quad:E(0,0,Y()*z()/K,N()*z()/K),tex:n.bgTex}),n.drawCalls=0,n.transformStack=[],n.transform=S()}function m(){d(),n.lastDrawCalls=n.drawCalls}function p(){return n.lastDrawCalls}function g(e){return y(e.x/Y()*2-1,-e.y/N()*2+1)}function w(e){n.transform=e.clone()}function A(e){!e||0===e.x&&0===e.y||(n.transform=n.transform.translate(e))}function T(e){!e||1===e.x&&1===e.y||(n.transform=n.transform.scale(e))}function _(e){!e||(n.transform=n.transform.rotateZ(e))}function D(){n.transformStack.push(n.transform.clone())}function F(){n.transformStack.length>0&&(n.transform=n.transformStack.pop())}function M(e={}){var t,r;let n=e.width||0,i=e.height||0,s=e.pos||y(0,0),o=H(e.origin||J).dot(y(n,i).scale(-.5)),a=y(null!=(t=e.scale)?t:1),l=e.rot||0,u=e.quad||E(0,0,1,1),h=1-(null!=(r=e.z)?r:0),d=e.color||P(1,1,1,1);D(),A(s),T(a),_(l),A(o),c([{pos:v(-n/2,i/2,h),uv:y(u.x,u.y+u.h),color:d},{pos:v(-n/2,-i/2,h),uv:y(u.x,u.y),color:d},{pos:v(n/2,-i/2,h),uv:y(u.x+u.w,u.y),color:d},{pos:v(n/2,i/2,h),uv:y(u.x+u.w,u.y+u.h),color:d}],[0,1,3,1,2,3],e.tex,e.prog,e.uniform),F()}function I(e,t={}){var r;let n=null!=(r=t.quad)?r:E(0,0,1,1),i=e.width*n.w,s=e.height*n.h;M(l(a({},t),{tex:e,quad:n,width:i,height:s}))}function L(e,t,r,n={}){M(l(a({},n),{pos:e,width:t,height:r}))}function C(e,t,r,n={}){let i=H(n.origin||J).dot(y(t,r)).scale(.5),s=e.add(y(-t/2,-r/2)).sub(i),o=e.add(y(-t/2,r/2)).sub(i),a=e.add(y(t/2,r/2)).sub(i),l=e.add(y(t/2,-r/2)).sub(i);q(s,o,n),q(o,a,n),q(a,l,n),q(l,s,n)}function q(e,t,r={}){let n=r.width||1,i=e.dist(t),s=Math.PI/2-e.angle(t);M(l(a({},r),{pos:e.add(t).scale(.5),width:n,height:i,rot:s,origin:"center"}))}function B(e,t,r={}){let n=(e+"").split(""),i=t.qw*t.tex.width,s=t.qh*t.tex.height,o=y((r.size||s)/s).dot(y(r.scale||1)),a=o.x*i,l=o.y*s,u=0,h=l,c=0,d=[[]];for(let e of n)("\n"===e||!!r.width&&u+a>r.width)&&(h+=l,u=0,d.push([])),"\n"!==e&&(d[d.length-1].push(e),u+=a),c=Math.max(c,u);r.width&&(c=r.width);let f=[],m=y(r.pos||0),p=H(r.origin||J).scale(.5),g=-p.x*a-(p.x+.5)*(c-a),w=-p.y*l-(p.y+.5)*(h-l);return d.forEach(((e,n)=>{let i=(c-e.length*a)*(p.x+.5);e.forEach(((e,s)=>{let u=t.map[e],h=s*a,c=n*l;u&&f.push({tex:t.tex,quad:E(u.x,u.y,t.qw,t.qh),ch:e,pos:y(m.x+h+g+i,m.y+c+w),color:r.color,origin:r.origin,scale:o,z:r.z})}))})),{width:c,height:h,chars:f}}function O(e,t,r={}){j(B(e,t,r))}function j(e){for(let t of e.chars)M({tex:t.tex,width:t.tex.width*t.quad.w,height:t.tex.height*t.quad.h,pos:t.pos,scale:t.scale,color:t.color,quad:t.quad,origin:"center",z:t.z})}function Y(){return e.drawingBufferWidth/z()}function N(){return e.drawingBufferHeight/z()}function z(){var e;return null!=(e=t.scale)?e:1}function X(){return n.clearColor.clone()}return f(),m(),u(i,"powerOfTwo"),u(s,"makeTex"),u(o,"makeProgram"),u(h,"makeFont"),u(c,"drawRaw"),u(d,"flush"),u(f,"frameStart"),u(m,"frameEnd"),u(p,"drawCalls"),u(g,"toNDC"),u(w,"pushMatrix"),u(A,"pushTranslate"),u(T,"pushScale"),u((function(e){!e||(n.transform=n.transform.rotateX(e))}),"pushRotateX"),u((function(e){!e||(n.transform=n.transform.rotateY(e))}),"pushRotateY"),u(_,"pushRotateZ"),u(D,"pushTransform"),u(F,"popTransform"),u(M,"drawQuad"),u(I,"drawTexture"),u(L,"drawRect"),u(C,"drawRectStroke"),u(q,"drawLine"),u(B,"fmtText"),u(O,"drawText"),u(j,"drawFmtText"),u(Y,"width"),u(N,"height"),u(z,"scale"),u(X,"clearColor"),{width:Y,height:N,scale:z,makeTex:s,makeProgram:o,makeFont:h,drawTexture:I,drawText:O,drawFmtText:j,drawRect:L,drawRectStroke:C,drawLine:q,fmtText:B,frameStart:f,frameEnd:m,pushTransform:D,popTransform:F,pushMatrix:w,drawCalls:p,clearColor:X}}var J,G,V,K,W,Q,Z,$,ee=h((()=>{N(),z(),J="topleft",G=9,V=65536,K=64,W="\nattribute vec3 a_pos;\nattribute vec2 a_uv;\nattribute vec4 a_color;\n\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvec4 def_vert() {\n\treturn vec4(a_pos, 1.0);\n}\n\n{{user}}\n\nvoid main() {\n\tvec4 pos = vert(a_pos, a_uv, a_color);\n\tv_pos = a_pos;\n\tv_uv = a_uv;\n\tv_color = a_color;\n\tgl_Position = pos;\n}\n",Q="\nprecision mediump float;\n\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nuniform sampler2D u_tex;\n\nvec4 def_frag() {\n\treturn v_color * texture2D(u_tex, v_uv);\n}\n\n{{user}}\n\nvoid main() {\n\tgl_FragColor = frag(v_pos, v_uv, v_color, u_tex);\n\tif (gl_FragColor.a == 0.0) {\n\t\tdiscard;\n\t}\n}\n",Z="\nvec4 vert(vec3 pos, vec2 uv, vec4 color) {\n\treturn def_vert();\n}\n",$="\nvec4 frag(vec3 pos, vec2 uv, vec4 color, sampler2D tex) {\n\treturn def_frag();\n}\n",u(H,"originPt"),u(X,"gfxInit")}));function te(e){return"pressed"===e||"rpressed"===e?"down":"released"===e?"up":e}function re(e={}){var t,r;let n={canvas:null!=(t=e.canvas)?t:(()=>{var t;let r=document.createElement("canvas");return(null!=(t=e.root)?t:document.body).appendChild(r),r})(),keyStates:{},charInputted:[],mouseState:"up",mousePos:y(0,0),time:0,realTime:0,skipTime:!1,dt:0,scale:null!=(r=e.scale)?r:1,isTouch:!1,loopID:null,stopped:!1,fps:0,fpsBuf:[],fpsTimer:0},i={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"},s=["space","left","right","up","down","tab","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11"];e.fullscreen?(n.canvas.width=window.innerWidth,n.canvas.height=window.innerHeight):(n.canvas.width=(e.width||640)*n.scale,n.canvas.height=(e.height||480)*n.scale);let o=["outline: none","cursor: default"];e.crisp&&(o.push("image-rendering: pixelated"),o.push("image-rendering: crisp-edges")),n.canvas.style=o.join(";"),n.canvas.setAttribute("tabindex","0");let a=n.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});function l(){return n.mousePos.clone()}function h(){return"pressed"===n.mouseState}function c(){return"pressed"===n.mouseState||"down"===n.mouseState}function d(){return"released"===n.mouseState}function f(e){return"pressed"===n.keyStates[e]}function m(e){return"pressed"===n.keyStates[e]||"rpressed"===n.keyStates[e]}function p(e){return"pressed"===n.keyStates[e]||"rpressed"===n.keyStates[e]||"down"===n.keyStates[e]}function g(e){return"released"===n.keyStates[e]}function w(){return[...n.charInputted]}function v(){return n.dt}function x(){return n.time}function b(){return n.fps}function k(){return n.canvas.toDataURL()}function R(e){return e&&(n.canvas.style.cursor=null!=e?e:"default"),n.canvas.style.cursor}function A(e){let t=u((r=>{let i=r/1e3,s=i-n.realTime;n.realTime=i,n.skipTime||(n.dt=s,n.time+=n.dt,n.fpsBuf.push(1/n.dt),n.fpsTimer+=n.dt,n.fpsTimer>=1&&(n.fpsTimer=0,n.fps=Math.round(n.fpsBuf.reduce(((e,t)=>e+t))/n.fpsBuf.length),n.fpsBuf=[])),n.skipTime=!1,e();for(let e in n.keyStates)n.keyStates[e]=te(n.keyStates[e]);n.mouseState=te(n.mouseState),n.charInputted=[],n.stopped||(n.loopID=requestAnimationFrame(t))}),"frame");n.loopID=requestAnimationFrame(t)}function P(){cancelAnimationFrame(n.loopID),n.stopped=!0}return n.isTouch="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,n.canvas.addEventListener("mousemove",(e=>{n.mousePos=y(e.offsetX,e.offsetY).scale(1/n.scale)})),n.canvas.addEventListener("mousedown",(()=>{n.mouseState="pressed"})),n.canvas.addEventListener("mouseup",(()=>{n.mouseState="released"})),n.canvas.addEventListener("touchstart",(e=>{let t=e.touches[0];n.mousePos=y(t.clientX,t.clientY).scale(1/n.scale),n.mouseState="pressed"})),n.canvas.addEventListener("touchmove",(e=>{let t=e.touches[0];n.mousePos=y(t.clientX,t.clientY).scale(1/n.scale)})),n.canvas.addEventListener("keydown",(e=>{let t=i[e.key]||e.key.toLowerCase();s.includes(t)&&e.preventDefault(),1===t.length&&n.charInputted.push(t),"space"===t&&n.charInputted.push(" "),e.repeat?n.keyStates[t]="rpressed":n.keyStates[t]="pressed"})),n.canvas.addEventListener("keyup",(e=>{let t=i[e.key]||e.key.toLowerCase();n.keyStates[t]="released"})),n.canvas.focus(),document.addEventListener("visibilitychange",(()=>{switch(document.visibilityState){case"visible":n.skipTime=!0}})),u(l,"mousePos"),u(h,"mouseClicked"),u(c,"mouseDown"),u(d,"mouseReleased"),u(f,"keyPressed"),u(m,"keyPressedRep"),u(p,"keyDown"),u(g,"keyReleased"),u(w,"charInputted"),u(v,"dt"),u(x,"time"),u(b,"fps"),u(k,"screenshot"),u(R,"cursor"),u(A,"run"),u(P,"quit"),{gl:a,mousePos:l,keyDown:p,keyPressed:f,keyPressedRep:m,keyReleased:g,mouseDown:c,mouseClicked:h,mouseReleased:d,charInputted:w,cursor:R,dt:v,time:x,fps:b,screenshot:k,run:A,quit:P}}var ne=h((()=>{N(),u(te,"processBtnState"),u(re,"appInit")}));function ie(){let e=(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain(),r=t;return r.connect(e.destination),{ctx:e,gainNode:t,masterNode:r}})();function t(t){return void 0!==t&&(e.gainNode.gain.value=f(t,se,oe)),e.gainNode.gain.value}function r(t,r={loop:!1,volume:1,speed:1,detune:0,seek:0}){var n;let i=!1,s=e.ctx.createBufferSource();s.buffer=t,s.loop=!!r.loop;let o=e.ctx.createGain();s.connect(o),o.connect(e.masterNode);let a=null!=(n=r.seek)?n:0;s.start(0,a);let l=e.ctx.currentTime-a,u=null,h={stop(){i||(this.pause(),l=e.ctx.currentTime)},play(t){if(!i)return;let r=s;s=e.ctx.createBufferSource(),s.buffer=r.buffer,s.loop=r.loop,s.playbackRate.value=r.playbackRate.value,s.detune&&(s.detune.value=r.detune.value),s.connect(o);let n=null!=t?t:this.time();s.start(0,n),l=e.ctx.currentTime-n,i=!1,u=null},pause(){i||(s.stop(),i=!0,u=e.ctx.currentTime)},paused:()=>i,stopped:()=>i,speed:e=>(void 0!==e&&(s.playbackRate.value=f(e,ae,le)),s.playbackRate.value),detune:e=>s.detune?(void 0!==e&&(s.detune.value=f(e,ue,he)),s.detune.value):0,volume:e=>(void 0!==e&&(o.gain.value=f(e,se,oe)),o.gain.value),loop(){s.loop=!0},unloop(){s.loop=!1},duration:()=>t.duration,time:()=>i?u-l:e.ctx.currentTime-l};return h.speed(r.speed),h.detune(r.detune),h.volume(r.volume),h}function n(){return e.ctx}return u(t,"volume"),u(r,"play"),u(n,"ctx"),{ctx:n,volume:t,play:r}}var se,oe,ae,le,ue,he,ce,de=h((()=>{N(),se=0,oe=3,ae=0,le=3,ue=-1200,he=1200,u(ie,"audioInit")})),fe=h((()=>{ce="data:image/png;base64,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"}));function me(e){let t=new Image;return t.src=e,t.crossOrigin="anonymous",new Promise(((r,n)=>{t.onload=()=>{r(t)},t.onerror=()=>{n(`failed to load ${e}`)}}))}function pe(e){return e.startsWith("data:")}function ge(e,t,r={}){let n={lastLoaderID:0,loadRoot:"",loaders:{},sprites:{},sounds:{},fonts:{},shaders:{}};function i(e){var t;let i=n.lastLoaderID;n.loaders[i]=!1,n.lastLoaderID++,e.catch(null!=(t=r.errHandler)?t:console.error).finally((()=>{n.loaders[i]=!0}))}function s(){let e=0,t=0;for(let r in n.loaders)e+=1,n.loaders[r]&&(t+=1);return t/e}function o(e){return e&&(n.loadRoot=e),n.loadRoot}function a(t,r,s,o,a=ye){let l=new Promise(((i,l)=>{me(pe(r)?r:n.loadRoot+r).then((r=>{let l=e.makeFont(e.makeTex(r),s,o,a);n.fonts[t]=l,i(l)})).catch(l)}));return i(l),l}function l(t,r,s={sliceX:1,sliceY:1,anims:{}}){function o(t,r,i={sliceX:1,sliceY:1,gridWidth:0,gridHeight:0,anims:{}}){let s=[],o=e.makeTex(r),a=i.sliceX||o.width/(i.gridWidth||o.width),l=i.sliceY||o.height/(i.gridHeight||o.height),u=1/a,h=1/l;for(let e=0;e<l;e++)for(let t=0;t<a;t++)s.push(E(t*u,e*h,u,h));let c={tex:o,frames:s,anims:i.anims||{}};return n.sprites[t]=c,c}u(o,"loadRawSprite");let a=new Promise(((e,i)=>{if(!r)return i(`expected sprite src for "${t}"`);"string"==typeof r?me(pe(r)?r:n.loadRoot+r).then((r=>{e(o(t,r,s))})).catch(i):e(o(t,r,s))}));return i(a),a}function h(t,r,s,o=!1){function a(t,r,i){let s=e.makeProgram(r,i);return n.shaders[t]=s,s}u(a,"loadRawShader");let l=new Promise(((e,i)=>{if(!r&&!s)return i("no shader");function l(e){return e?fetch(n.loadRoot+e).then((t=>{if(t.ok)return t.text();throw new Error(`failed to load ${e}`)})).catch(i):new Promise((e=>e(null)))}if(u(l,"resolveUrl"),o)Promise.all([l(r),l(s)]).then((([r,n])=>{e(a(t,r,n))})).catch(i);else try{e(a(t,r,s))}catch(e){i(e)}}));return i(l),l}function c(e,r){let s=n.loadRoot+r,o=new Promise(((i,o)=>{if(!r)return o(`expected sound src for "${e}"`);"string"==typeof r&&fetch(s).then((e=>{if(e.ok)return e.arrayBuffer();throw new Error(`failed to load ${s}`)})).then((e=>new Promise(((r,n)=>{t.ctx().decodeAudioData(e,r,n)})))).then((t=>{n.sounds[e]=t,i(t)})).catch(o)}));return i(o),o}function d(){return n.fonts[we]}return u(i,"addLoader"),u(s,"loadProgress"),u(o,"loadRoot"),u(a,"loadFont"),u(l,"loadSprite"),u(h,"loadShader"),u(c,"loadSound"),u(d,"defFont"),a(we,ce,8,8),{loadRoot:o,loadSprite:l,loadSound:c,loadFont:a,loadShader:h,loadProgress:s,addLoader:i,defFont:d,sprites:n.sprites,fonts:n.fonts,sounds:n.sounds,shaders:n.shaders}}var ye,we,ve=h((()=>{N(),fe(),ye=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",we="unscii",u(me,"loadImg"),u(pe,"isDataUrl"),u(ge,"assetsInit")}));function xe(e,t,r={max:8}){var n;let i=[],s=null!=(n=r.max)?n:8;function o(){i.length>s&&(i=i.slice(0,s));let r=y(0,e.height());i.forEach(((n,i)=>{let o=p(i,0,s,1,.5),a=p(i,0,s,.8,.2),l=(()=>{switch(n.type){case"info":return P(1,1,1,o);case"error":return P(1,0,.5,o)}})(),u=e.fmtText(n.msg,t.defFont(),{pos:r,origin:"botleft",color:l,size:be/e.scale(),width:e.width()});e.drawRect(r,u.width,u.height,{origin:"botleft",color:P(0,0,0,a)}),e.drawFmtText(u),r.y-=u.height}))}function a(e){console.error(e),i.unshift({type:"error",msg:e})}function l(e){i.unshift({type:"info",msg:e})}function h(){i=[]}return u(o,"draw"),u(a,"error"),u(l,"info"),u(h,"clear"),{info:l,error:a,draw:o,clear:h}}var be,ke=h((()=>{N(),be=16,u(xe,"loggerInit")}));function Re(e){let t={},r=[],n=null;function i(){return null!==n&&1===n.readyState}function s(){let i=new WebSocket(e);return new Promise(((s,o)=>{i.onopen=()=>{s(i),n=i;for(let e of r)i.send(e)},i.onerror=()=>{o(`failed to connect to ${e}`)},i.onmessage=e=>{let r=JSON.parse(e.data);if(t[r.type])for(let e of t[r.type])e(r.data,r.id)}}))}function o(e,r){t[e]||(t[e]=[]),t[e].push(r)}function a(e,t){let i=JSON.stringify({type:e,data:t});n?n.send(i):r.push(i)}function l(){n&&n.close()}return u(i,"connected"),u(s,"connect"),u(o,"recv"),u(a,"send"),u(l,"close"),{connect:s,close:l,connected:i,recv:o,send:a}}var Ae,Pe,Ee=h((()=>{u(Re,"netInit")}));const Se=(Ae=(e,t)=>{N(),ee(),ne(),de(),ve(),ke(),Ee(),t.exports=(e={width:640,height:480,scale:1,fullscreen:!1,debug:!1,crisp:!1,canvas:null,connect:null,logMax:8,root:document.body})=>{let t=re({width:e.width,height:e.height,scale:e.scale,fullscreen:e.fullscreen,crisp:e.crisp,canvas:e.canvas,root:e.root}),r=X(t.gl,{clearColor:e.clearColor?P(e.clearColor):void 0,scale:e.scale,texFilter:e.texFilter}),n=ie(),i=ge(r,n,{errHandler:e=>{s.error(e)}}),s=xe(r,i,{max:e.logMax}),o=e.connect?Re(e.connect):null;function h(e,t){if(!o)throw new Error("not connected to any websockets");o.recv(e,((e,r)=>{try{t(e,r)}catch(e){s.error(e)}}))}function v(e,t){if(!o)throw new Error("not connected to any websockets");o.send(e,t)}function x(){return t.dt()*Qe.timeScale}function b(e,t={}){let r=i.sounds[e];if(!r)throw new Error(`sound not found: "${e}"`);return n.play(r,t)}function k(e){var t;let r=N();return!(null==(t=r.layers[null!=e?e:r.defLayer])?void 0:t.noCam)}function R(e){return k(e)?N().cam.mpos:t.mousePos()}function B(e,t={}){var n;let s="string"==typeof e?i.sprites[e]:e;if(!s)throw new Error(`sprite not found: "${e}"`);let o=s.frames[null!=(n=t.frame)?n:0];r.drawTexture(s.tex,l(a({},t),{quad:o}))}function O(e,t={}){var n;let s=null!=(n=t.font)?n:we,o=i.fonts[s];if(!o)throw new Error(`font not found: ${s}`);r.drawText(e,o,t)}u(h,"recv"),u(v,"send"),u(x,"dt"),u(b,"play"),u(k,"isCamLayer"),u(R,"mousePos"),u(B,"drawSprite"),u(O,"drawText");let j={loaded:!1,scenes:{},curScene:null,nextScene:null};function Y(e,t){j.scenes[e]={init:t,initialized:!1,events:{add:[],update:[],draw:[],destroy:[],keyDown:[],keyPress:[],keyPressRep:[],keyRelease:[],mouseClick:[],mouseRelease:[],mouseDown:[],charInput:[]},action:[],render:[],objs:new Map,lastObjID:0,timers:{},lastTimerID:0,cam:{pos:y(r.width()/2,r.height()/2),scale:y(1,1),angle:0,shake:0,mpos:y(0),matrix:S()},layers:{},defLayer:null,gravity:980,data:{}}}function N(){return j.scenes[j.curScene]}function U(){return N().data}function z(){pe("`",(()=>{Qe.showLog=!Qe.showLog,s.info("show log: "+(Qe.showLog?"on":"off"))})),pe("f1",(()=>{Qe.inspect=!Qe.inspect,s.info("inspect: "+(Qe.inspect?"on":"off"))})),pe("f2",(()=>{Qe.clearLog()})),pe("f8",(()=>{Qe.paused=!Qe.paused,s.info(Qe.paused?"paused":"unpaused")})),pe("f7",(()=>{Qe.timeScale=f(Qe.timeScale-.2,0,2),s.info(`time scale: ${Qe.timeScale.toFixed(1)}`)})),pe("f9",(()=>{Qe.timeScale=f(Qe.timeScale+.2,0,2),s.info(`time scale: ${Qe.timeScale.toFixed(1)}`)})),pe("f10",(()=>{Qe.stepFrame(),s.info("stepped frame")}))}function J(e,...t){j.nextScene={name:e,args:[...t]}}function G(t,...r){V(t),j.curScene=t;let n=j.scenes[t];if(!n)throw new Error(`scene not found: '${t}'`);if(!n.initialized){try{n.init(...r)}catch(e){s.error(e.stack)}e.debug&&z(),n.initialized=!0}}function V(e){if(!j.scenes[e])throw new Error(`scene not found: '${e}'`);Y(e,j.scenes[e].init)}function K(e,t){let r=N();!r||(e.forEach(((e,t)=>{r.layers[e]={alpha:1,order:t+1,noCam:!1}})),t&&(r.defLayer=t))}function W(...e){let t=N().cam;return e.length>0&&(t.pos=y(...e)),t.pos.clone()}function Q(...e){let t=N().cam;return e.length>0&&(t.scale=y(...e)),t.scale.clone()}function Z(e){let t=N().cam;return void 0!==e&&(t.angle=e),t.angle}function $(e){N().cam.shake=e}function ee(e){let t=N();e.forEach((e=>{t.layers[e]&&(t.layers[e].noCam=!0)}))}function te(e){let t={hidden:!1,paused:!1,_tags:[],_id:null,_events:{add:[],update:[],draw:[],destroy:[],inspect:[]},use(e){if(void 0===e)return;let t=typeof e;if("string"!==t){if("object"!==t)throw new Error(`invalid comp type: ${t}`);if(Array.isArray(e))for(let t of e)this.use(t);else for(let t in e)"function"!=typeof e[t]?this[t]=e[t]:this._events[t]?this._events[t].push(e[t].bind(this)):this[t]=e[t].bind(this)}else this._tags.push(e)},exists(){return void 0!==this._id},is(e){if("*"===e)return!0;if(Array.isArray(e)){for(let t of e)if(!this._tags.includes(t))return!1;return!0}return this._tags.includes(e)},on(e,t){this._events[e]||(this._events[e]=[]),this._events[e].push(t)},action(e){this.on("update",e)},trigger(e,...t){if(this._events[e])for(let r of this._events[e])r.call(this,...t);let r=N().events[e];if(r)for(let e of r)this.is(e.tag)&&e.cb(this,...t)},rmTag(e){let t=this._tags.indexOf(e);t>-1&&this._tags.splice(t,1)}};t.use(e);let r=N(),n=r.lastObjID++;r.objs.set(n,t),t._id=n,t.trigger("add");for(let e of r.events.add)t.is(e.tag)&&e.cb(t);return t}function ne(e){if(!e.exists())return;let t=N();t.objs.delete(e._id);let r=t.lastObjID++;return t.objs.set(r,e),e._id=r,e}function se(e,t,r){let n=N();n.events[e]||(n.events[e]=[]),n.events[e].push({tag:t,cb:r})}function oe(e,t){"function"==typeof e&&void 0===t?N().action.push(e):"string"==typeof e&&se("update",e,t)}function ae(e,t){"function"==typeof e&&void 0===t?N().render.push(e):"string"==typeof e&&se("update",e,t)}function le(e,t,r){oe(e,(e=>{e._checkCollisions(t,(t=>{r(e,t)}))}))}function ue(e,t,r){oe(e,(e=>{e._checkOverlaps(t,(t=>{r(e,t)}))}))}function he(e,t){oe(e,(e=>{e.isClicked()&&t(e)}))}function ce(e,t){return new Promise((r=>{let n=N();n.timers[n.lastTimerID++]={time:e,cb:()=>{t&&t(),r()}}}))}function de(e,t){let r=!1,n=u((()=>{r||(t(),ce(e,n))}),"newF");return n(),{stop(){r=!0}}}function fe(e,t,r){if(Array.isArray(t))for(let n of t)fe(e,n,r);else N().events[e].push({key:t,cb:r})}function me(e,t){fe("keyDown",e,t)}function pe(e,t){fe("keyPress",e,t)}function ye(e,t){fe("keyPressRep",e,t)}function ve(e,t){fe("keyRelease",e,t)}function be(e){N().events.charInput.push({cb:e})}function ke(e){N().events.mouseDown.push({cb:e})}function Ae(e){N().events.mouseClick.push({cb:e})}function Pe(e){N().events.mouseRelease.push({cb:e})}function Ee(e){let t=N(),r=[...t.objs.values()].sort(((e,r)=>{var n,i,s,o,a,l;return(null!=(s=null==(i=t.layers[null!=(n=e.layer)?n:t.defLayer])?void 0:i.order)?s:0)-(null!=(l=null==(a=t.layers[null!=(o=r.layer)?o:t.defLayer])?void 0:a.order)?l:0)}));return e?r.filter((t=>t.is(e))):r}function Se(e,t){"function"==typeof e&&void 0===t?Ee().forEach(e):"string"==typeof e&&Ee(e).forEach(t)}function Te(e,t){"function"==typeof e&&void 0===t?Ee().reverse().forEach(e):"string"==typeof e&&Ee(e).reverse().forEach(t)}function _e(e){if(!e.exists())return;let t=N();!t||(e.trigger("destroy"),t.objs.delete(e._id),delete e._id)}function De(e){Se(e,(e=>{_e(e)}))}function Fe(e){let t=N();return void 0!==e&&(t.gravity=e),t.gravity}function Me(e){let n=N();if(!n)throw new Error(`scene not found: '${j.curScene}'`);let i=e||!Qe.paused;if(i)for(let e in n.timers){let t=n.timers[e];t.time-=x(),t.time<=0&&(t.cb(),delete n.timers[e])}if(Te((e=>{!e.paused&&i&&e.trigger("update")})),i)for(let e of n.action)e();let s=y(r.width(),r.height()),o=n.cam,a=w(F(0,2*Math.PI)).scale(o.shake);o.shake=m(o.shake,0,5*x()),o.matrix=S().translate(s.scale(.5)).scale(o.scale).rotateZ(o.angle).translate(s.scale(-.5)).translate(o.pos.scale(-1).add(s.scale(.5)).add(a)),o.mpos=o.matrix.invert().multVec2(t.mousePos()),Se((e=>{e.hidden||(r.pushTransform(),k(e.layer)&&r.pushMatrix(o.matrix),e.trigger("draw"),r.popTransform())}));for(let e of n.render)e()}function Ie(){let e=N();for(let r of e.events.charInput)t.charInputted().forEach(r.cb);for(let r of e.events.keyDown)t.keyDown(r.key)&&r.cb();for(let r of e.events.keyPress)t.keyPressed(r.key)&&r.cb();for(let r of e.events.keyPressRep)t.keyPressedRep(r.key)&&r.cb();for(let r of e.events.keyRelease)t.keyReleased(r.key)&&r.cb();for(let r of e.events.mouseDown)t.mouseDown()&&r.cb();for(let r of e.events.mouseClick)t.mouseClicked()&&r.cb();for(let r of e.events.mouseRelease)t.mouseReleased()&&r.cb()}function Le(){var n;let s=N(),o=null,a=i.defFont(),l=P(null!=(n=e.inspectColor)?n:[0,1,1,1]);function h(e,t,n){let i=y(4).scale(1/n),s=r.fmtText(t,a,{size:12/n,pos:e.add(y(i.x,i.y))});r.drawRect(e,s.width+2*i.x,s.height+2*i.x,{color:P(0,0,0,1)}),r.drawFmtText(s)}function c(e,t){let n=k(e.layer),i=r.scale()*(n?(s.cam.scale.x+s.cam.scale.y)/2:1);n&&(r.pushTransform(),r.pushMatrix(s.cam.matrix)),t(i),n&&r.popTransform()}u(h,"drawInspectTxt"),u(c,"drawObj"),Te((e=>{!e.area||e.hidden||c(e,(t=>{o||e.isHovered()&&(o=e);let n=(o===e?6:2)/t,i=e._worldArea(),s=i.p2.x-i.p1.x,a=i.p2.y-i.p1.y;r.drawRectStroke(i.p1,s,a,{width:n,color:l})}))})),o&&c(o,(e=>{let t=R(o.layer),r=[];for(let e of o._tags)r.push(`"${e}"`);for(let e of o._events.inspect){let t=e();for(let e in t)r.push(`${e}: ${t[e]}`)}h(t,r.join("\n"),e)})),h(y(0),t.fps()+"",r.scale())}function Ce(e,...n){t.run((()=>{if(r.frameStart(),j.loaded){try{if(!N())throw new Error(`scene not found: '${j.curScene}'`);Ie(),Me(),Qe.inspect&&Le()}catch(e){s.error(e.stack),t.quit()}Qe.showLog&&s.draw(),j.nextScene&&(G.apply(null,[j.nextScene.name,...j.nextScene.args]),j.nextScene=null)}else{let t=i.loadProgress();if(1===t)j.loaded=!0,G(e,...n),o&&o.connect().catch(s.error);else{let e=r.width()/2,n=24/r.scale(),i=y(r.width()/2,r.height()/2).sub(y(e/2,n/2));r.drawRect(y(0),r.width(),r.height(),{color:A(0,0,0)}),r.drawRectStroke(i,e,n,{width:4/r.scale()}),r.drawRect(i,e*t,n)}}r.frameEnd()}))}function qe(...e){return{pos:y(...e),move(...e){let t=y(...e),r=t.x*x(),n=t.y*x();this.pos.x+=r,this.pos.y+=n},inspect(){return{pos:`(${~~this.pos.x}, ${~~this.pos.y})`}}}}function Be(...e){return 0===e.length?Be(1):{scale:y(...e),flipX(e){this.scale.x=Math.sign(e)*Math.abs(this.scale.x)},flipY(e){this.scale.y=Math.sign(e)*Math.abs(this.scale.y)}}}function Oe(e){return{angle:null!=e?e:0}}function je(...e){return{color:P(...e)}}function Ye(e){return{origin:e}}function Ne(e){return{layer:e,inspect(){var e;let t=N();return{layer:null!=(e=this.layer)?e:t.defLayer}}}}function Ue(e,t){var r,n;let i=N();return(null!=(r=e.layer)?r:i.defLayer)===(null!=(n=t.layer)?n:i.defLayer)}function ze(e,r){let n={},i={};return{area:{p1:e,p2:r},areaWidth(){let{p1:e,p2:t}=this._worldArea();return t.x-e.x},areaHeight(){let{p1:e,p2:t}=this._worldArea();return t.y-e.y},isClicked(){return t.mouseClicked()&&this.isHovered()},isHovered(){return this.hasPt(R(this.layer))},isCollided(e){return!(!e.area||!Ue(this,e))&&L(this._worldArea(),e._worldArea())},isOverlapped(e){return!(!e.area||!Ue(this,e))&&C(this._worldArea(),e._worldArea())},clicks(e){this.action((()=>{this.isClicked()&&e()}))},hovers(e){this.action((()=>{this.isHovered()&&e()}))},collides(e,t){this.action((()=>{this._checkCollisions(e,t)}))},overlaps(e,t){this.action((()=>{this._checkOverlaps(e,t)}))},hasPt(e){let t=this._worldArea();return q({p1:t.p1,p2:t.p2},e)},resolve(){let e=[];return Se((t=>{if(t===this||!t.solid||!t.area||!Ue(this,t))return;let r=this._worldArea(),n=t._worldArea();if(!L(r,n))return;let i=r.p2.x-n.p1.x,s=n.p2.x-r.p1.x,o=r.p2.y-n.p1.y,a=n.p2.y-r.p1.y,l=Math.min(i,s,o,a),u=(()=>{switch(l){case i:return this.pos.x-=i,"right";case s:return this.pos.x+=s,"left";case o:return this.pos.y-=o,"bottom";case a:return this.pos.y+=a,"top"}})();e.push({obj:t,side:u})})),e},_checkCollisions(e,t){Se(e,(e=>{this!==e&&(n[e._id]||this.isCollided(e)&&(t(e),n[e._id]=e))}));for(let e in n){let t=n[e];this.isCollided(t)||delete n[e]}},_checkOverlaps(e,t){Se(e,(e=>{this!==e&&(i[e._id]||this.isOverlapped(e)&&(t(e),i[e._id]=e))}));for(let e in i){let t=i[e];this.isOverlapped(t)||delete i[e]}},_worldArea(){let e=this.area,t=this.pos||y(0),r=this.scale||y(1),n=t.add(e.p1.dot(r)),i=t.add(e.p2.dot(r));return{p1:y(Math.min(n.x,i.x),Math.min(n.y,i.y)),p2:y(Math.max(n.x,i.x),Math.max(n.y,i.y))}}}}function He(e,t,r){let n=y(e,t),i=H(r||"topleft").dot(n).scale(-.5);return ze(i.sub(n.scale(.5)),i.add(n.scale(.5)))}function Xe(e,t={}){let r=i.sprites[e];if(!r)throw new Error(`sprite not found: "${e}"`);let n=a({},r.frames[0]);t.quad&&(n.x+=t.quad.x*n.w,n.y+=t.quad.y*n.h,n.w*=t.quad.w,n.h*=t.quad.h);let s=r.tex.width*n.w,o=r.tex.height*n.h,l=null;return{width:s,height:o,animSpeed:t.animSpeed||.1,frame:t.frame||0,quad:t.quad||E(0,0,1,1),add(){!this.area&&!t.noArea&&this.use(He(this.width,this.height,this.origin))},draw(){N(),r.frames[this.frame],B(r,{pos:this.pos,scale:this.scale,rot:this.angle,color:this.color,frame:this.frame,origin:this.origin,quad:this.quad,prog:i.shaders[this.shader],uniform:this.uniform})},update(){if(!l)return;let e=r.anims[l.name];l.timer+=x(),l.timer>=this.animSpeed&&(this.frame++,this.frame>e.to&&(l.loop?this.frame=e.from:(this.frame--,this.stop())),l&&(l.timer-=this.animSpeed))},play(e,t=!0){let n=r.anims[e];if(!n)throw new Error(`anim not found: ${e}`);l&&this.stop(),l={name:e,loop:t,timer:0},this.frame=n.from,this.trigger("animPlay",e)},stop(){if(!l)return;let e=l.name;l=null,this.trigger("animEnd",e)},changeSprite(e){if(r=i.sprites[e],!r)throw new Error(`sprite not found: "${e}"`);let n=a({},r.frames[0]);t.quad&&(n.x+=t.quad.x*n.w,n.y+=t.quad.y*n.h,n.w*=t.quad.w,n.h*=t.quad.h),this.width=r.tex.width*n.w,this.height=r.tex.height*n.h,this.area&&!t.noArea&&this.use(He(this.width,this.height,this.origin)),l=null,this.frame=0},numFrames:()=>r.frames.length,curAnim:()=>null==l?void 0:l.name,inspect(){let e={};return l&&(e.curAnim=`"${l.name}"`),e}}}function Je(e,t,n={}){return{text:e,textSize:t,font:n.font,width:0,height:0,add(){var e,t,s;if(!this.area&&!n.noArea){N();let o=i.fonts[null!=(e=this.font)?e:we],a=r.fmtText(this.text+"",o,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:n.width});this.width=a.width/((null==(t=this.scale)?void 0:t.x)||1),this.height=a.height/((null==(s=this.scale)?void 0:s.y)||1),this.use(He(this.width,this.height,this.origin))}},draw(){var e;N();let t=i.fonts[null!=(e=this.font)?e:we],s=r.fmtText(this.text+"",t,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:n.width});this.width=s.width,this.height=s.height,r.drawFmtText(s)}}}function Ge(e,t,n={}){return{width:e,height:t,add(){!this.area&&!n.noArea&&this.use(He(this.width,this.height,this.origin))},draw(){N(),r.drawRect(this.pos,this.width,this.height,{scale:this.scale,rot:this.angle,color:this.color,origin:this.origin,prog:i.shaders[this.shader],uniform:this.uniform})}}}function Ve(){return{solid:!0}}function Ke(e={}){var t,r;let n=0,i=null,s=null,o=null!=(t=e.maxVel)?t:960;return{jumpForce:null!=(r=e.jumpForce)?r:480,update(){this.move(0,n);let e=this.resolve(),t=!1;if(i&&(i.exists()&&this.isCollided(i)?s&&(this.pos=this.pos.add(i.pos.sub(s)),s=i.pos.clone()):(i=null,s=null,t=!0)),!i){n=Math.min(n+Fe()*x(),o);for(let r of e)"bottom"===r.side&&n>0?(i=r.obj,n=0,s=i.pos.clone(),t||this.trigger("grounded",i)):"top"===r.side&&n<0&&(n=0,this.trigger("headbump",r.obj))}},curPlatform:()=>i,grounded:()=>null!==i,falling:()=>n>0,jump(e){i=null,n=-e||-this.jumpForce}}}function We(e,t={}){return i.shaders[e],{shader:e,uniform:t}}u(Y,"scene"),u(N,"curScene"),u(U,"sceneData"),u(z,"regDebugInputs"),u(J,"go"),u(G,"goSync"),u(V,"reload"),u(K,"layers"),u(W,"camPos"),u(Q,"camScale"),u(Z,"camRot"),u($,"camShake"),u(ee,"camIgnore"),u(te,"add"),u(ne,"readd"),u(se,"on"),u(oe,"action"),u(ae,"render"),u(le,"collides"),u(ue,"overlaps"),u(he,"clicks"),u(ce,"wait"),u(de,"loop"),u(fe,"pushKeyEvent"),u(me,"keyDown"),u(pe,"keyPress"),u(ye,"keyPressRep"),u(ve,"keyRelease"),u(be,"charInput"),u(ke,"mouseDown"),u(Ae,"mouseClick"),u(Pe,"mouseRelease"),u(Ee,"get"),u(Se,"every"),u(Te,"revery"),u(_e,"destroy"),u(De,"destroyAll"),u(Fe,"gravity"),u(Me,"gameFrame"),u(Ie,"handleEvents"),u(Le,"drawInspect"),u(Ce,"start"),u(qe,"pos"),u(Be,"scale"),u(Oe,"rotate"),u(je,"color"),u(Ye,"origin"),u(Ne,"layer"),u(Ue,"isSameLayer"),u(ze,"area"),u(He,"getAreaFromSize"),u(Xe,"sprite"),u(Je,"text"),u(Ge,"rect"),u(Ve,"solid"),u(Ke,"body"),u(We,"shader");let Qe={paused:!1,inspect:!1,timeScale:1,showLog:!0,fps:t.fps,objCount:()=>N().objs.size,stepFrame(){Me(!0)},drawCalls:r.drawCalls,clearLog:s.clear,log:s.info,error:s.error};function Ze(e,t){let r=[],n=y(t.pos||0),i=0,s={getPos(...e){let r=y(...e);return y(n.x+r.x*t.width,n.y+r.y*t.height)},spawn(e,i){let s=(()=>{if(Array.isArray(e))return e;if(t[e]){if("function"==typeof t[e])return t[e]();if(Array.isArray(t[e]))return[...t[e]]}else if(t.any)return t.any(e)})();if(!s)return;s.push(qe(n.x+i.x*t.width,n.y+i.y*t.height));let o=te(s);return r.push(o),o.use({gridPos:i.clone(),setGridPos(e){this.gridPos=e.clone(),this.pos=y(n.x+this.gridPos.x*t.width,n.y+this.gridPos.y*t.height)},moveLeft(){this.setGridPos(this.gridPos.add(y(-1,0)))},moveRight(){this.setGridPos(this.gridPos.add(y(1,0)))},moveUp(){this.setGridPos(this.gridPos.add(y(0,-1)))},moveDown(){this.setGridPos(this.gridPos.add(y(0,1)))}}),o},width:()=>i*t.width,height:()=>e.length*t.height,destroy(){for(let e of r)_e(e)}};return e.forEach(((e,t)=>{let r=e.split("");i=Math.max(r.length,i),r.forEach(((e,r)=>{s.spawn(e,y(r,t))}))})),s}u(Ze,"addLevel");let $e={start:Ce,loadRoot:i.loadRoot,loadSprite:i.loadSprite,loadSound:i.loadSound,loadFont:i.loadFont,loadShader:i.loadShader,addLoader:i.addLoader,width:r.width,height:r.height,dt:x,time:t.time,screenshot:t.screenshot,scene:Y,go:J,sceneData:U,layers:K,camPos:W,camScale:Q,camRot:Z,camShake:$,camIgnore:ee,gravity:Fe,add:te,readd:ne,destroy:_e,destroyAll:De,get:Ee,every:Se,revery:Te,send:v,recv:h,pos:qe,scale:Be,rotate:Oe,color:je,origin:Ye,layer:Ne,area:ze,sprite:Xe,text:Je,rect:Ge,solid:Ve,body:Ke,shader:We,on:se,action:oe,render:ae,collides:le,overlaps:ue,clicks:he,keyDown:me,keyPress:pe,keyPressRep:ye,keyRelease:ve,charInput:be,mouseDown:ke,mouseClick:Ae,mouseRelease:Pe,mousePos:R,cursor:t.cursor,keyIsDown:t.keyDown,keyIsPressed:t.keyPressed,keyIsPressedRep:t.keyPressedRep,keyIsReleased:t.keyReleased,mouseIsDown:t.mouseDown,mouseIsClicked:t.mouseClicked,mouseIsReleased:t.mouseReleased,loop:de,wait:ce,play:b,volume:n.volume,makeRng:_,rand:F,randSeed:D,vec2:y,rgb:A,rgba:P,quad:E,choose:I,chance:M,lerp:m,map:p,mapc:g,wave:T,deg2rad:c,rad2deg:d,drawSprite:B,drawText:O,drawRect:r.drawRect,drawRectStroke:r.drawRectStroke,drawLine:r.drawLine,debug:Qe,addLevel:Ze};if(e.plugins)for(let t of e.plugins){let e=t($e);for(let t in e)$e[t]=e[t]}if(e.global)for(let e in $e)window[e]=$e[e];return $e}},()=>(Pe||Ae(Pe={exports:{}},Pe),Pe.exports))()();Se.scene("hello",(()=>{Se.add([Se.text("ohhimarx",32),Se.pos(100,100)])})),Se.start("hello")})();